<?xml version='1.0' encoding='UTF-8'?>
<Rule>
    <规则编号>SQLE00118</规则编号>
    <级别>notice</级别>
    <数据库类型>MySQL</数据库类型>
    <规则种类>数据修改和操作安全</规则种类>
    <规则简述>建议在执行DROP/TRUNCATE等操作前进行备份</规则简述>
    <规则描述>DROP/TRUNCATE是DDL，操作立即生效，不会写入日志，所以无法回滚，在执行高危操作之前对数据进行备份是很有必要的</规则描述>
    <规则场景>
        <原理说明 数据库版本="MySQL 所有版本" 检查方式="不连库审核" 适用句型="DROP TABLE、TRUNCATE TABLE">
            <示例>
                前置:
                create database db_mysql;
                use db_mysql;
                create table t1(
                    a int primary key, 
                    c1 varchar(100) 
                );

                -- 样例数据：
                insert into t1 values (1,'ob');
                insert into t1 values (2,null);
                insert into t1 values (3,'actionsky');

                
                原理说明:
                1. DROP TABLE、TRUNATE TABLE 操作无法回滚，操作前要格外注意。
                2. 对于MySQL 来讲，DROP TABLE、TRUNCATE TABLE 操作不会记录数据的变更（也就是没有对应的回滚段）到二进制日志，记录的数据不够用于回滚；操作前提前备份数据库，降低犯错成本。

                示例:
                1. DROP TABLE t1;
                2. TRUNCATE TABLE T1;

                示例说明：
                1. DROP TABLE、TRUNCATE TABLE 无法回滚，操作上请注意。

                示例验证:
                (mysql:8.3.0:db_mysql)begin;
                Query OK, 0 rows affected (0.00 sec)
                
                (mysql:8.3.0:db_mysql)drop table t1;
                Query OK, 0 rows affected (0.03 sec)
                
                (mysql:8.3.0:db_mysql)rollback;
                Query OK, 0 rows affected (0.00 sec)
                
                (mysql:8.3.0:db_mysql)select * from t1;
                ERROR 1146 (42S02): Table 'db_mysql.t1' doesn't exist

                对应的二进制日志内容： 事务 5b65ad11-011b-11ef-88e6-08002789d7fb:1 对应的变更数据没有记录进去，即使有二进制日志也无法回滚。
                (mysql:8.3.0:db_mysql)show binlog events;
                +---------------+-----+----------------+-----------+-------------+------------------------------------------------------------------------+
                | Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                                   |
                +---------------+-----+----------------+-----------+-------------+------------------------------------------------------------------------+
                | binlog.000001 |   4 | Format_desc    |      3306 |         127 | Server ver: 8.3.0, Binlog ver: 4                                       |
                | binlog.000001 | 127 | Previous_gtids |      3306 |         158 |                                                                        |
                | binlog.000001 | 158 | Gtid           |      3306 |         235 | SET @@SESSION.GTID_NEXT= '5b65ad11-011b-11ef-88e6-08002789d7fb:1'      |
                | binlog.000001 | 235 | Query          |      3306 |         370 | use `db_mysql`; DROP TABLE `t1` /* generated by server */ /* xid=65 */ |
                +---------------+-----+----------------+-----------+-------------+------------------------------------------------------------------------+
                4 rows in set (0.00 sec)

                结论:
                1. 执行 DROP TABLE、TRUNCATE TABLE 语句后，事务无法回滚，所以最好提前备份好数据。

            </示例>
            <检查流程描述>
                1. 对于提供的SQL语句，检查以下条件，如果有任意一个条件触发，则报告违反规则：
                    1. 语句中包含有 "DROP TABLE" 子句.
                    2. 语句中包含有 "TRUNCATE TABLE" 子句.
            </检查流程描述>
            <知识文档>
              1. 事务提交回滚 官方文档： https://dev.mysql.com/doc/refman/8.0/en/commit.html
              2. 事务隐式提交 官方文档: https://dev.mysql.com/doc/refman/8.0/en/implicit-commit.html
            </知识文档>
        </原理说明>
    </规则场景>
<标签><分类 名称="操作对象"><分类值>表</分类值><分类值>业务数据</分类值></分类><分类 名称="SQL分类"><分类值>DDL</分类值></分类><分类 名称="审核目的"><分类值>增强安全性</分类值></分类><分类 名称="审核精确度"><分类值>不连库审核</分类值></分类></标签><完成情况>完成</完成情况></Rule>