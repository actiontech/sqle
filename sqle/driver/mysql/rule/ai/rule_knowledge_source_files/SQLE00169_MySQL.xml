<?xml version='1.0' encoding='UTF-8'?>
<Rule>
    <规则编号>SQLE00169</规则编号>
    <级别>warn</级别>
    <数据库类型>MySQL</数据库类型>
    <规则种类>DDL操作风险防护</规则种类>
    <适用性>不适用当前数据库</适用性>
    <规则简述>禁止增加带默认值的列</规则简述>
    <规则描述>给表增加带默认值的列，会导致全表被锁</规则描述>
    <规则场景>
        <场景 名称="初始化表结构定义" 数据库版本="大于等于 MySQL 5.7" 检查方式="不连库审核" 适用句型="ALTER TABLE">
            <示例>
              前置：
              示例表结构:
```sql
              create database db_mysql;
              use db_mysql;
    
              -- 主表
              CREATE TABLE customers(
                id INT(11) NOT NULL, -- 序号
                name VARCHAR(32) DEFAULT '',-- 姓名
                sex TINYINT NOT NULL, -- 性别
                city VARCHAR(32) NOT NULL, -- 所在城市
                age SMALLINT(4) NOT NULL, -- 值类型
                PRIMARY KEY (id) -- 主键
              );

    
              -- 插入模拟数据,200W 条。
              set @@cte_max_recursion_depth=20000000;
              insert into customers  
              with recursive tmp (a,b,c,d,e) as (
                select 1,'小王22222333',floor(rand()*2),'上海',ceil(rand()*30)+20 
                union all 
                select a+1,concat('小王',a),floor(rand()*2),'上海',ceil(rand()*20)+20 from tmp where a &lt; 2000000) 
                select * from tmp;

```
              原理说明：
              1. 在目前官方支持的MySQL版本中（大于等于 MySQL 5.7），给表添加带默认值的列只会更新数据字典数据，不会导致全表被锁。此规则不适用。
              2. ONLINE DDL 请参考规则：SQLE00059

              示例：
```sql
              alter table customers add mark1 varchar(100) default 'test';
              alter table customers add mark2 varchar(100) default 'test' not null;

```
              示例说明：
              1. 给表 customers 添加两个列，一个列mark1 有默认值，可以为NULL；另外一个列 mark2，有默认值，不为NULL。


              示例验证：
              1. 当前MySQL 版本：8.3.0
```sql
              (mysql:8.3.0:db_mysql)select version();
              +-----------+
              | version() |
              +-----------+
              | 8.3.0     |
              +-----------+
              1 row in set (0.00 sec)
              
```
              2.表 customers 记录数200W
```sql
              (mysql:8.3.0:db_mysql)select count(*) from customers;
              +----------+
              | count(*) |
              +----------+
              |  2000000 |
              +----------+
              1 row in set (0.58 sec)
              

```
              3. 给表customers 添加列 mark1，默认值为 'test': 瞬间执行完成。
```sql
              (mysql:8.3.0:db_mysql)alter table customers add mark1 varchar(100) default 'test';
              Query OK, 0 rows affected (0.11 sec)
              Records: 0  Duplicates: 0  Warnings: 0
              

```
              4. 给表customers 添加列 mark2，默认值为 'test'，并且不为NULL： 瞬间完成。
```sql
              (mysql:8.3.0:db_mysql)alter table customers add mark2 varchar(100) default 'test' not null;
              Query OK, 0 rows affected (0.04 sec)
              Records: 0  Duplicates: 0  Warnings: 0
              
```
              结论：
              1. 在目前官方支持的MySQL版本中（大于等于 MySQL 5.7），给表添加带默认值的列只会更新数据字典数据，不会导致全表被锁。此规则不适用。
      
            </示例>
            <知识文档>
              1. MySQL ONLINE DDL 列操作官方文档：https://dev.mysql.com/doc/refman/8.0/en/innodb-online-ddl-operations.html#online-ddl-column-operations
            </知识文档>
        </场景>
    </规则场景>
    <标签><分类 名称="操作对象"><分类值>字段</分类值></分类><分类 名称="SQL分类"><分类值>DDL</分类值><分类值>完整性约束</分类值></分类><分类 名称="审核目的"><分类值>保障正确性</分类值></分类><分类 名称="审核精确度"><分类值>不连库审核</分类值></分类></标签><完成情况>完成</完成情况></Rule>