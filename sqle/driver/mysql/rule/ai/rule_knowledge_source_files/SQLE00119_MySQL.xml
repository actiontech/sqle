<?xml version='1.0' encoding='UTF-8'?>
<Rule>
    <规则编号>SQLE00119</规则编号>
    <级别>warn</级别>
    <数据库类型>MySQL</数据库类型>
    <规则种类>排序和分组效率</规则种类>
    <规则简述>建议为GROUP BY语句添加ORDER BY条件</规则简述>
    <规则描述>GROUP BY 语句不加ORDER BY，结果将无序或者非预期的排序。建议加上ORDER BY 条件，按照一定的顺序来展示查询结果。</规则描述>
    <规则场景>
        <原理说明 数据库版本="MySQL 版本大于等于5.7" 检查方式="不连库审核" 适用关键词="SELECT、INSERT ...SELECT、DELETE、UPDATE、UNION、WITH">
            <示例>
            示例表结构:
            create database db_mysql;
            use db_mysql;

            CREATE TABLE customers(
            id INT(11) NOT NULL, -- 序号
            name VARCHAR(32) DEFAULT '',-- 姓名
            sex TINYINT NOT NULL, -- 性别
            city VARCHAR(32) NOT NULL, -- 所在城市
            age SMALLINT(4) NOT NULL, -- 值类型
            PRIMARY KEY (id) -- 主键
            );



            -- 插入模拟数据 10 条。
            insert into customers values (1,'lily1',1,'shanghai',20);
            insert into customers values (2,'lily2',0,'shanghai',30);
            insert into customers values (3,'lily3',1,'shanghai',20);
            insert into customers values (4,'lily4',0,'shanghai',20);
            insert into customers values (5,'lily5',1,'shanghai',30);
            insert into customers values (6,'lily6',0,'shanghai',20);
            insert into customers values (7,'lily7',1,'shanghai',30);
            insert into customers values (8,'lily8',0,'shanghai',40);
            insert into customers values (9,'lily9',1,'shanghai',20);
            insert into customers values (10,'lily10',1,'shanghai',40);

      
            原理说明：
            1. GROUP BY 不加ORDER BY ，会导致结果无序或者非预期的排序；特别是在MySQL8.0版本之前，如果未显示指定排序规则，会出现隐式排序，不确定性的排序结果通常无法满足业务预期。
            2. 建议加上 ORDER BY ，将按照指定的字段排序，更好地符合预期。

            反例：
            select age from customers group by age;

            反例说明：
            SQL 中使用GROUP BY ，但是没有显式指定ORDER BY 子句。

            反例验证： 
            (mysql:8.4.0:db_mysql)select age from customers group by age order by age asc;
            +-----+
            | age |
            +-----+
            |  20 |
            |  30 |
            |  40 |
            +-----+
            3 rows in set (0.00 sec)
            

            正例：
            select age from customers group by age order by age desc;

            正例说明：
            SQL 中使用GROUP BY ，并且显式使用 ORDER BY 对指定的字段排序，符合预期。

            正例验证：
            (mysql:8.4.0:db_mysql)select age from customers group by age order by age desc;
            +-----+
            | age |
            +-----+
            |  40 |
            |  30 |
            |  20 |
            +-----+
            3 rows in set (0.00 sec)
        
            结论：
            1. GROUP BY 语句建议加上ORDER BY 子句，按照指定的字段排序，增强结果的可读性。
         
  
            </示例>
            <检查流程描述>
            1. 对于所有DML语句，对于SELECT子句中存在GROUP BY子句，但是对GROUP BY结果没有ORDER BY操作，则报告违反规则。
            2. 对于“WITH ...”语句，进行与上述相同的检查。
            </检查流程描述>
            <知识文档>
            1. SQL 优化官方文档： https://dev.mysql.com/doc/refman/8.0/en/statement-optimization.html
            </知识文档>
        </原理说明>
    </规则场景>
    <关联规则>SQLE00104、SQLE00102、SQLE00101、SQLE00121</关联规则>
    <标签><分类 名称="操作对象"><分类值>业务数据</分类值></分类><分类 名称="SQL分类"><分类值>DML</分类值></分类><分类 名称="审核目的"><分类值>发现性能问题</分类值></分类><分类 名称="审核精确度"><分类值>不连库审核</分类值></分类></标签><完成情况>完成</完成情况></Rule>