<?xml version='1.0' encoding='UTF-8'?>
<Rule>
    <规则编号>SQLE00151</规则编号>
    <级别>error</级别>
    <数据库类型>MySQL</数据库类型>
    <规则种类>DDL规范</规则种类>
    <规则简述>避免CREATE TABLE/ALTER TABLE 使用禁止的表空间</规则简述>
    <规则描述>不允许在系统表空间上创建用户对象，避免不必要的安全风险，方便维护</规则描述>
    <规则场景>
        <原理说明 数据库版本="MySQL 所有版本" 检查方式="不连库审核">
            <示例>

              错误示例：
              -- 表使用系统表空间。
              CREATE TABLE customers (
               id INT, -- 编号
               name VARCHAR(50), -- 姓名
               sex int, -- 性别
               city VARCHAR(50), -- 城市
               age INT, -- 年龄
               log_date varchar(20),  -- 记录日志时间
               primary key (id) -- 主键
               ) tablespace innodb_system; -- 表使用系统表空间

               -- 或者使用了默认空空间，但是后期又改成了系统表空间
               CREATE TABLE customers (
                id INT, -- 编号
                name VARCHAR(50), -- 姓名
                sex int, -- 性别
                city VARCHAR(50), -- 城市
                age INT, -- 年龄
                log_date varchar(20),  -- 记录日志时间
                primary key (id) -- 主键
                );

                -- 更改为系统表空间
                alter table customers tablespace innodb_system;

               原理说明：
                1. MySQL 有系统表空间，用来存放系统对象的元数据等。在磁盘上表现为数据目录下的ibdata1,...,ibdataN等一系列文件。
                2. 禁止在系统表空间上创建用户表。有三个原因：
                   1. 如果用户表坏了，系统表也一起坏，不安全；
                   2. 如果用户表很大，也会放大系统表空间的大小，严重影响性能。
                   3. 用户表的数据重建，需要连带着重建系统表空间，对运维不友好。
                3. 所以强烈禁止使用系统表空间建表。

                解决方案：
                1. CREATE TABLE 时，不带tablespace 关键词，即可使用单表空间
                CREATE TABLE customers (
                    id int, -- 编号
                    name VARCHAR(50), -- 姓名
                    sex int, -- 性别
                    city VARCHAR(50), -- 城市
                    age int, -- 年龄
                    log_date date,  -- 记录日志时间
                    primary key (id) -- 主键
                    );
                    
                2. 对已经使用系统表空间的表，更改为单表空间。
                alter table customers tablespace innodb_file_per_table;

                
            </示例>
            <检查流程描述>
            1. 对于 "CREATE TABLE..."语句，检查语句是否存在关键词 tablespace innodb_system，如果存在， 则报告违反规则。
            2. 对于 "ALTER TABLE... TABLESPACE..." 语句，检查语句是否存在关键词 tablespace innodb_system，如果存在， 则报告违反规则。
            </检查流程描述>            
            <知识文档>
              1. CREATE TABLE 官方文档： https://dev.mysql.com/doc/refman/8.0/en/create-table.html
              2. ALTER TABLE 官方文档： https://dev.mysql.com/doc/refman/8.0/en/alter-table.html
              3. CREATE TABLESPACE 官方文档： https://dev.mysql.com/doc/refman/8.0/en/create-tablespace.html
            </知识文档>
        </原理说明>
    </规则场景>
    <关联规则>SQLE00148</关联规则>
    <标签><分类 名称="操作对象"><分类值>表</分类值></分类><分类 名称="SQL分类"><分类值>DDL</分类值></分类><分类 名称="审核目的"><分类值>增强安全性</分类值></分类><分类 名称="审核精确度"><分类值>不连库审核</分类值></分类></标签><完成情况>完成</完成情况></Rule>