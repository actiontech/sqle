<?xml version='1.0' encoding='UTF-8'?>
<Rule>
<规则编号>SQLE00078</规则编号>
<级别>error</级别>
<数据库类型>MySQL</数据库类型>
<规则种类>DML规范</规则种类>
<规则简述>禁止使用聚合函数</规则简述>
<规则描述>禁止使用SQL聚合函数是为了确保查询的简单性、高性能和数据一致性。</规则描述>
<规则场景>
  <原理说明 数据库版本="MySQL 5.7.25" 检查方式="不连库审核">
    <示例>
      前置：
      CREATE TABLE t2 (
          id INT(11) NOT NULL,
          name VARCHAR(32) DEFAULT NULL,
          type VARCHAR(4),
          score numeric(5,2),
          PRIMARY KEY (id),
          index idx_t2_name (name) USING BTREE
      );

      INSERT INTO t2 VALUES(1,'t1','a',12),(2,'2t','a3',23),(3,'t3','a4',24),(4,'4t','a2',NULL);

      示例：
      SELECT COUNT(1) FROM t2;###全表聚合统计
      SELECT name,COUNT(1) as cn FROM t2 GROUP BY name;###配合group by进行聚合统计
      SELECT name,AVG(score) as avgscore FROM t2 GROUP BY name;###配合group by进行聚合统计的分类
      SELECT name,AVG(score) as avgscore FROM t2 GROUP BY name having AVG(score)&gt; 0;###配合having子句进行聚合统计的筛选

      示例说明：
      聚合函数通常搭配SELECT句型、GROUP BY、HAVING子句进行使用。常用聚合函数，如COUNT、SUM、AVG、MIN、MAX等。其中SUM、AVG这四类函数是数值型统计，没有特别说明，基本会忽略NULL值的字段，容易造成统计不精确。引用官方文档说明：Unless otherwise stated, aggregate functions ignore NULL values. 

      示例验证：
      统计全量数据条数与Score为非NULL的数据条数
      mysql&gt; select count(1) from t2;
      +----------+
      | count(1) |
      +----------+
      |      4 |
      +----------+
      1 row in set (0.00 sec)  

      mysql&gt; select count(1) from t2 where score is not null;
      +----------+
      | count(1) |
      +----------+
      |      3 |
      +----------+
      1 row in set (0.00 sec)          

      计算全量平均值，正确的值应该是14.75。
      mysql&gt; select avg(score) as avgs from t2;
      +-----------+
      | avgs      |
      +-----------+
      | 19.666667 |
      +-----------+
      1 row in set (0.00 sec)      

      计算非NULL的平均值
      mysql&gt; select avg(score) as avgs from t2 where score is not null;
      +-----------+
      | avgs      |
      +-----------+
      | 19.666667 |
      +-----------+
      1 row in set (0.00 sec)  
      
      解决方案：
      1）调整业务SQL：select avg(coalesce(score,0)) as avgs from t2;
      2）处理表数据的NULL值：UPDATE t2 set score =0 where score is null;

    </示例>
    <检查流程描述>
      1、检查句子中是否包含SELECT关键词，存在则进一步检查。
      2、检查句子中是否存在聚合函数，存在报告违反规则。
    </检查流程描述>
    <知识文档>
      1、聚合函数：https://dev.mysql.com/doc/refman/5.7/en/aggregate-functions.html
      2、应用文档：https://zhuanlan.zhihu.com/p/455642740
    </知识文档>
  </原理说明>
</规则场景>
<标签><分类 名称="操作对象"><分类值>业务数据</分类值></分类><分类 名称="SQL分类"><分类值>DML</分类值></分类><分类 名称="审核目的"><分类值>增强可维护性</分类值><分类值>发现性能问题</分类值></分类><分类 名称="审核精确度"><分类值>不连库审核</分类值></分类></标签><完成情况>完成</完成情况></Rule>